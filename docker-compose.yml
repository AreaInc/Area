---
services:
  etcd1: &etcd
    build: database/etcd
    container_name: etcd1
    hostname: etcd1
    networks:
      - patroni
    env_file:
      - database/etcd/.env
    environment:
      ETCD_NAME: etcd1
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd1:2379
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd1:2380
    volumes:
      - etcd1-data:/etcd-data
    healthcheck: &etcd-health
      test: ["CMD", "etcdctl", "--endpoints=http://etcd1:2379", "endpoint", "health"]
      interval: 5s
      timeout: 3s
      retries: 3

  etcd2:
    <<: *etcd
    container_name: etcd2
    hostname: etcd2
    env_file:
      - database/etcd/.env
    environment:
      ETCD_NAME: etcd2
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd2:2379
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd2:2380
    volumes:
      - etcd2-data:/etcd-data
    healthcheck:
      <<: *etcd-health
      test: ["CMD", "etcdctl", "--endpoints=http://etcd2:2379", "endpoint", "health"]

  etcd3:
    <<: *etcd
    container_name: etcd3
    hostname: etcd3
    env_file:
      - database/etcd/.env
    environment:
      ETCD_NAME: etcd3
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd3:2379
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd3:2380
    volumes:
      - etcd3-data:/etcd-data
    healthcheck:
      <<: *etcd-health
      test: ["CMD", "etcdctl", "--endpoints=http://etcd3:2379", "endpoint", "health"]

  haproxy:
    build: database/haproxy
    container_name: haproxy
    hostname: haproxy
    depends_on:
      - etcd1
      - etcd2
      - etcd3
    networks:
      - patroni
    ports:
      - "5000:5000"
      - "5001:5001"
    environment:
      ETCDCTL_ENDPOINTS: http://etcd1:2379,http://etcd2:2379,http://etcd3:2379
      PATRONI_ETCD3_HOSTS: "'etcd1:2379','etcd2:2379','etcd3:2379'"
      PATRONI_SCOPE: demo
    healthcheck:
      test: ["CMD-SHELL", "(command -v curl >/dev/null && curl -sSf http://localhost:5000/ >/dev/null) || (ps aux | grep -v grep | grep haproxy >/dev/null)"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  patroni1: &patroni
    build: database/postgresql
    container_name: patroni-1
    hostname: postgres-1
    depends_on:
      - etcd1
      - etcd2
      - etcd3
    env_file:
      - database/postgresql/.env
    environment:
      PATRONI_NAME: ${NODE1_NAME}
      PATRONI_RESTAPI_LISTEN: 0.0.0.0:${NODE1_API_PORT}
      PATRONI_RESTAPI_CONNECT_ADDRESS: ${NODE1_HOST}:${NODE1_API_PORT}
      PATRONI_POSTGRESQL_LISTEN: 0.0.0.0:${NODE1_POSTGRES_PORT}
      PATRONI_POSTGRESQL_CONNECT_ADDRESS: ${NODE1_HOST}:${NODE1_POSTGRES_PORT}
    volumes:
      - patroni1-data:/var/lib/postgresql/data
      - ./database/postgresql/patroni.yml.template:/patroni.yml.template:ro
    restart: unless-stopped
    networks:
      - patroni
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres" ]
      interval: 5s
      timeout: 3s
      start_period: 5s
      retries: 5

  patroni2:
    <<: *patroni
    container_name: patroni-2
    hostname: postgres-2
    depends_on:
      - etcd1
      - etcd2
      - etcd3
    env_file:
      - database/postgresql/.env
    environment:
      PATRONI_NAME: ${NODE2_NAME}
      PATRONI_RESTAPI_LISTEN: 0.0.0.0:${NODE2_API_PORT}
      PATRONI_RESTAPI_CONNECT_ADDRESS: ${NODE2_HOST}:${NODE2_API_PORT}
      PATRONI_POSTGRESQL_LISTEN: 0.0.0.0:${NODE2_POSTGRES_PORT}
      PATRONI_POSTGRESQL_CONNECT_ADDRESS: ${NODE2_HOST}:${NODE2_POSTGRES_PORT}
    volumes:
      - patroni2-data:/var/lib/postgresql/data
      - ./database/postgresql/patroni.yml.template:/patroni.yml.template:ro
    restart: unless-stopped
    networks:
      - patroni
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres" ]
      interval: 5s
      timeout: 3s
      start_period: 5s
      retries: 5

  patroni3:
    <<: *patroni
    container_name: patroni-3
    hostname: postgres-3
    depends_on:
      - etcd1
      - etcd2
      - etcd3
    env_file:
      - database/postgresql/.env
    environment:
      PATRONI_NAME: ${NODE3_NAME}
      PATRONI_RESTAPI_LISTEN: 0.0.0.0:${NODE3_API_PORT}
      PATRONI_RESTAPI_CONNECT_ADDRESS: ${NODE3_HOST}:${NODE3_API_PORT}
      PATRONI_POSTGRESQL_LISTEN: 0.0.0.0:${NODE3_POSTGRES_PORT}
      PATRONI_POSTGRESQL_CONNECT_ADDRESS: ${NODE3_HOST}:${NODE3_POSTGRES_PORT}
    volumes:
      - patroni3-data:/var/lib/postgresql/data
      - ./database/postgresql/patroni.yml.template:/patroni.yml.template:ro
    restart: unless-stopped
    networks:
      - patroni
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres" ]
      interval: 5s
      timeout: 3s
      start_period: 5s
      retries: 5

  # area-postgres:
  #   image: postgres:15-alpine
  #   container_name: area-postgres
  #   environment:
  #     POSTGRES_DB: ${POSTGRES_NAME:-area}
  #     POSTGRES_USER: ${POSTGRES_USER:-area_user}
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-area_password}
  #   ports:
  #     - "5432:5432"
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-area_user} -d ${POSTGRES_NAME:-area}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - area-network
  #
  # backend:
  #   build:
  #     context: ./backend
  #     dockerfile: Dockerfile
  #   container_name: area-backend
  #   ports:
  #     - "8080:8080"
  #   environment:
  #     - NODE_ENV=production
  #     - POSTGRES_HOST=${POSTGRES_HOST}
  #     - POSTGRES_PORT=${POSTGRES_PORT}
  #     - POSTGRES_NAME=${POSTGRES_NAME:-area}
  #     - POSTGRES_USER=${POSTGRES_USER:-area_user}
  #     - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-area_password}
  #     - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
  #     - BACKEND_PORT=${BACKEND_PORT}
  #   depends_on:
  #     area-postgres:
  #       condition: service_healthy
  #   networks:
  #     - area-network
  #
  # # frontend:
  # #   build:
  # #     context: ./frontend/web
  # #     dockerfile: Dockerfile
  # #   container_name: area-frontend
  # #   ports:
  # #     - "8081:80"
  # #   depends_on:
  # #     - backend
  # #   networks:
  # #     - area-network
  #
  # vault:
  #   image: hashicorp/vault:latest
  #   container_name: vault
  #   restart: unless-stopped
  #   ports:
  #     - "8200:8200"
  #   environment:
  #     - VAULT_DEV_ROOT_TOKEN_ID=myroot
  #     - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
  #   volumes:
  #     - vault_data:/vault/file

networks:
  patroni:
  # area-network:
  #   driver: bridge

volumes:
  # postgres_data:
  # vault_data:
  etcd1-data:
  etcd2-data:
  etcd3-data:
  patroni1-data:
  patroni2-data:
  patroni3-data:
