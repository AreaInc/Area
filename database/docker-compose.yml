---
services:
  etcd1: &etcd
    build:
      context: ./etcd
    container_name: etcd1
    hostname: etcd1
    restart: unless-stopped
    networks:
      - patroni
    env_file:
      - ./etcd/.env
    environment:
      ETCD_NAME: etcd1
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd1:2379
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd1:2380
    volumes:
      - etcd1-data:/etcd-data
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
        reservations:
          memory: 256M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck: &etcd-health
      test: ["CMD", "etcdctl", "--endpoints=http://localhost:2379", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  etcd2:
    <<: *etcd
    container_name: etcd2
    hostname: etcd2
    environment:
      ETCD_NAME: etcd2
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd2:2379
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd2:2380
    volumes:
      - etcd2-data:/etcd-data

  etcd3:
    <<: *etcd
    container_name: etcd3
    hostname: etcd3
    environment:
      ETCD_NAME: etcd3
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd3:2379
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd3:2380
    volumes:
      - etcd3-data:/etcd-data

  haproxy:
    build:
      context: ./haproxy
    container_name: haproxy
    hostname: haproxy
    depends_on:
      patroni1:
        condition: service_healthy
      patroni2:
        condition: service_healthy
      patroni3:
        condition: service_healthy
      etcd1:
        condition: service_healthy
      etcd2:
        condition: service_healthy
      etcd3:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - patroni
    ports:
      - "5000:5000"
      - "5001:5001"
      - "7000:7000"
    environment:
      ETCDCTL_ENDPOINTS: http://etcd1:2379,http://etcd2:2379,http://etcd3:2379
      PATRONI_ETCD3_HOSTS: "'etcd1:2379','etcd2:2379','etcd3:2379'"
      PATRONI_SCOPE: demo
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"
        reservations:
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "pidof haproxy"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  patroni1: &patroni
    build:
      context: ./postgresql
    container_name: patroni-1
    hostname: postgres-1
    depends_on:
      etcd1:
        condition: service_healthy
      etcd2:
        condition: service_healthy
      etcd3:
        condition: service_healthy
    env_file:
      - ./postgresql/.env
      - ./postgresql/.env1
    volumes:
      - patroni1-data:/var/lib/postgresql/data
      - ./postgresql/patroni.yml.template:/patroni.yml.template:ro
    restart: unless-stopped
    networks:
      - patroni
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
        reservations:
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    healthcheck: &patroni-health
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 10s
      timeout: 5s
      start_period: 30s
      retries: 5

  patroni2:
    <<: *patroni
    container_name: patroni-2
    hostname: postgres-2
    env_file:
      - ./postgresql/.env
      - ./postgresql/.env2
    volumes:
      - patroni2-data:/var/lib/postgresql/data
      - ./postgresql/patroni.yml.template:/patroni.yml.template:ro

  patroni3:
    <<: *patroni
    container_name: patroni-3
    hostname: postgres-3
    env_file:
      - ./postgresql/.env
      - ./postgresql/.env3
    volumes:
      - patroni3-data:/var/lib/postgresql/data
      - ./postgresql/patroni.yml.template:/patroni.yml.template:ro

networks:
  patroni:
    name: area-patroni

volumes:
  etcd1-data:
  etcd2-data:
  etcd3-data:
  patroni1-data:
  patroni2-data:
  patroni3-data:
